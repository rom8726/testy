{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Testy Test Scenarios",
  "description": "JSON Schema for testy functional testing framework scenarios",
  "type": "array",
  "items": {
    "type": "object",
    "required": ["name", "steps"],
    "properties": {
      "name": {
        "type": "string",
        "description": "Name of the test scenario"
      },
      "variables": {
        "type": "object",
        "description": "Test-level variables (key-value pairs)",
        "additionalProperties": true
      },
      "fixtures": {
        "type": "array",
        "description": "List of fixture files to load (without .yml extension)",
        "items": {
          "type": "string"
        }
      },
      "setup": {
        "type": "array",
        "description": "Setup hooks executed before test steps",
        "items": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Optional hook name for logging"
            },
            "sql": {
              "type": "string",
              "description": "SQL query to execute (supports placeholders)"
            },
            "http": {
              "type": "object",
              "description": "HTTP request hook",
              "required": ["method", "path"],
              "properties": {
                "method": {
                  "type": "string",
                  "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"],
                  "description": "HTTP method"
                },
                "path": {
                  "type": "string",
                  "description": "Request path (supports placeholders)"
                },
                "headers": {
                  "type": "object",
                  "description": "Request headers (supports placeholders)",
                  "additionalProperties": {
                    "type": "string"
                  }
                },
                "body": {
                  "description": "Request body (any valid JSON/YAML, supports placeholders)"
                }
              }
            }
          },
          "oneOf": [
            {"required": ["sql"]},
            {"required": ["http"]}
          ]
        }
      },
      "teardown": {
        "type": "array",
        "description": "Teardown hooks executed after test steps (even on failure)",
        "items": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Optional hook name for logging"
            },
            "sql": {
              "type": "string",
              "description": "SQL query to execute (supports placeholders)"
            },
            "http": {
              "type": "object",
              "description": "HTTP request hook",
              "required": ["method", "path"],
              "properties": {
                "method": {
                  "type": "string",
                  "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"],
                  "description": "HTTP method"
                },
                "path": {
                  "type": "string",
                  "description": "Request path (supports placeholders)"
                },
                "headers": {
                  "type": "object",
                  "description": "Request headers (supports placeholders)",
                  "additionalProperties": {
                    "type": "string"
                  }
                },
                "body": {
                  "description": "Request body (any valid JSON/YAML, supports placeholders)"
                }
              }
            }
          },
          "oneOf": [
            {"required": ["sql"]},
            {"required": ["http"]}
          ]
        }
      },
      "mockServers": {
        "type": "object",
        "description": "HTTP mock servers configuration",
        "additionalProperties": {
          "type": "object",
          "properties": {
            "routes": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["method", "path", "response"],
                "properties": {
                  "method": {
                    "type": "string",
                    "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"],
                    "description": "HTTP method"
                  },
                  "path": {
                    "type": "string",
                    "description": "URL path for the mock route"
                  },
                  "response": {
                    "type": "object",
                    "required": ["status"],
                    "properties": {
                      "status": {
                        "type": "integer",
                        "description": "HTTP status code",
                        "minimum": 100,
                        "maximum": 599
                      },
                      "headers": {
                        "type": "object",
                        "description": "Response headers",
                        "additionalProperties": {
                          "type": "string"
                        }
                      },
                      "json": {
                        "type": "string",
                        "description": "JSON response body as string"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "mockCalls": {
        "type": "array",
        "description": "Expected mock server calls verification",
        "items": {
          "type": "object",
          "required": ["mock", "count"],
          "properties": {
            "mock": {
              "type": "string",
              "description": "Name of the mock server"
            },
            "count": {
              "type": "integer",
              "description": "Expected number of calls",
              "minimum": 0
            },
            "expect": {
              "type": "object",
              "description": "Expected request properties",
              "properties": {
                "method": {
                  "type": "string",
                  "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"]
                },
                "path": {
                  "type": "string"
                },
                "body": {
                  "type": "object",
                  "properties": {
                    "contains": {
                      "type": "string",
                      "description": "String that should be contained in request body"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "steps": {
        "type": "array",
        "description": "Test steps to execute",
        "minItems": 1,
        "items": {
          "type": "object",
          "required": ["name", "request", "response"],
          "properties": {
            "name": {
              "type": "string",
              "description": "Unique step name (used for referencing in placeholders)"
            },
            "when": {
              "type": "string",
              "description": "Conditional execution expression (e.g., '{{status}} == active', '{{age}} >= 18')"
            },
            "loop": {
              "type": "object",
              "description": "Loop configuration for iterating over items or range",
              "properties": {
                "items": {
                  "description": "Array of items to iterate over",
                  "type": "array"
                },
                "var": {
                  "type": "string",
                  "description": "Variable name for current item in loop"
                },
                "range": {
                  "type": "object",
                  "description": "Numeric range to iterate over",
                  "required": ["from", "to"],
                  "properties": {
                    "from": {
                      "type": "integer",
                      "description": "Start value (inclusive)"
                    },
                    "to": {
                      "type": "integer",
                      "description": "End value (inclusive)"
                    },
                    "step": {
                      "type": "integer",
                      "description": "Step increment (default: 1)",
                      "default": 1,
                      "minimum": 1
                    }
                  }
                }
              },
              "oneOf": [
                {"required": ["items", "var"]},
                {"required": ["range", "var"]}
              ]
            },
            "retry": {
              "type": "object",
              "description": "Retry configuration for failed requests",
              "required": ["attempts"],
              "properties": {
                "attempts": {
                  "type": "integer",
                  "description": "Maximum number of attempts (including first try)",
                  "minimum": 1
                },
                "backoff": {
                  "type": "string",
                  "enum": ["constant", "linear", "exponential"],
                  "description": "Backoff strategy",
                  "default": "exponential"
                },
                "initialDelay": {
                  "type": "string",
                  "description": "Initial delay before first retry (e.g., '100ms', '1s')",
                  "pattern": "^\\d+(ms|s|m|h)$"
                },
                "maxDelay": {
                  "type": "string",
                  "description": "Maximum delay for exponential backoff (e.g., '10s', '1m')",
                  "pattern": "^\\d+(ms|s|m|h)$"
                },
                "retryOn": {
                  "type": "array",
                  "description": "Retry only on these HTTP status codes",
                  "items": {
                    "type": "integer",
                    "minimum": 100,
                    "maximum": 599
                  }
                },
                "retryOnError": {
                  "type": "boolean",
                  "description": "Retry on any error (network, timeout, etc.)",
                  "default": false
                }
              }
            },
            "request": {
              "type": "object",
              "required": ["method", "path"],
              "properties": {
                "method": {
                  "type": "string",
                  "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS", "TRACE", "CONNECT"],
                  "description": "HTTP method"
                },
                "path": {
                  "type": "string",
                  "description": "Request path (supports placeholders like {{step.response.field}})"
                },
                "headers": {
                  "type": "object",
                  "description": "Request headers (supports placeholders)",
                  "additionalProperties": {
                    "type": "string"
                  }
                },
                "body": {
                  "description": "Request body (any valid JSON/YAML, supports placeholders and faker functions like {{faker.name}}, {{faker.email}})"
                },
                "bodyFile": {
                  "type": "string",
                  "description": "Path to file containing request body"
                },
                "bodyRaw": {
                  "type": "string",
                  "description": "Raw request body as string"
                }
              }
            },
            "response": {
              "type": "object",
              "required": ["status"],
              "properties": {
                "status": {
                  "type": "integer",
                  "description": "Expected HTTP status code",
                  "minimum": 100,
                  "maximum": 599
                },
                "headers": {
                  "type": "object",
                  "description": "Expected response headers",
                  "additionalProperties": {
                    "type": "string"
                  }
                },
                "json": {
                  "type": "string",
                  "description": "Expected JSON response body (supports jsonassert placeholders like <<PRESENCE>>)"
                },
                "text": {
                  "type": "string",
                  "description": "Expected text response body"
                },
                "schema": {
                  "type": "string",
                  "description": "Path to external JSON Schema file for validation"
                },
                "jsonSchema": {
                  "description": "Inline JSON Schema (Draft 7) for response validation",
                  "type": "object"
                },
                "assertions": {
                  "type": "array",
                  "description": "Enhanced assertions for response validation",
                  "items": {
                    "type": "object",
                    "required": ["path", "operator"],
                    "properties": {
                      "path": {
                        "type": "string",
                        "description": "JSON path to value (supports dot notation and array indexing, e.g., 'users[0].age')"
                      },
                      "operator": {
                        "type": "string",
                        "enum": [
                          "equals", "eq", "==",
                          "notEquals", "ne", "!=",
                          "greaterThan", "gt", ">",
                          "lessThan", "lt", "<",
                          "greaterOrEqual", "gte", ">=",
                          "lessOrEqual", "lte", "<=",
                          "between",
                          "contains",
                          "notContains",
                          "matches",
                          "startsWith",
                          "endsWith",
                          "in",
                          "notIn",
                          "isEmpty",
                          "isNotEmpty",
                          "hasLength",
                          "hasMinLength",
                          "hasMaxLength"
                        ],
                        "description": "Assertion operator"
                      },
                      "value": {
                        "description": "Expected value (for 'between' operator: array [min, max])"
                      },
                      "message": {
                        "type": "string",
                        "description": "Optional custom error message"
                      }
                    }
                  }
                }
              }
            },
            "performance": {
              "type": "object",
              "description": "Performance constraints for the request",
              "properties": {
                "maxDuration": {
                  "type": "string",
                  "description": "Maximum allowed duration (e.g., '500ms', '1s')",
                  "pattern": "^\\d+(ms|s|m|h)$"
                },
                "warnDuration": {
                  "type": "string",
                  "description": "Warning threshold for duration (e.g., '200ms', '500ms')",
                  "pattern": "^\\d+(ms|s|m|h)$"
                },
                "failOnWarning": {
                  "type": "boolean",
                  "description": "Fail test if warning threshold is exceeded",
                  "default": false
                },
                "maxMemory": {
                  "type": "integer",
                  "description": "Maximum memory usage in MB",
                  "minimum": 1
                },
                "minThroughput": {
                  "type": "integer",
                  "description": "Minimum requests per second (for batch operations)",
                  "minimum": 1
                }
              }
            },
            "dbChecks": {
              "type": "array",
              "description": "Database assertions to run after the step",
              "items": {
                "type": "object",
                "required": ["query", "result"],
                "properties": {
                  "query": {
                    "type": "string",
                    "description": "SQL query to execute (supports placeholders)"
                  },
                  "result": {
                    "description": "Expected result as JSON array or YAML (supports placeholders)"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
